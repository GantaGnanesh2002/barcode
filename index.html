<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barcode Inventory Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f4f4f4;
      text-align: center;
    }
    #reader {
      width: 100%;
      max-width: 360px;
      margin: auto;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      width: 80%;
      max-width: 300px;
    }
    button {
      background: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
    }
    button:hover {
      background: #0056b3;
    }
    .section {
      background: white;
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
    .qty-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .qty-controls input {
      width: 50px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>ðŸ“¦ Barcode Inventory Scanner</h2>

<div id="reader"></div>

<div id="status">Waiting for scan...</div>

<div id="foundItem" class="section" style="display:none;">
  <h3>Item Found</h3>
  <p><strong>Name:</strong> <span id="itemName"></span></p>
  <p><strong>Scale:</strong> <span id="itemScale"></span></p>
  <p><strong>Department:</strong> <span id="itemDept"></span></p>

  <div class="qty-controls">
    <button onclick="changeQty(-1)">-</button>
    <input id="quantity" type="number" value="1" min="1" max="10" readonly />
    <button onclick="changeQty(1)">+</button>
  </div>
  <button onclick="placeOrder()">Place Order</button>
  <div style="margin-top:10px;">
    <input id="deletePassword" type="password" placeholder="Delete password (6986)" />
    <button onclick="deleteItem()">Delete Item</button>
  </div>
</div>

<div id="newItemForm" class="section" style="display:none;">
  <h3>Item Not Found - Add New</h3>
  <input id="newName" type="text" placeholder="Item Name" /><br>
  <input id="newScale" type="text" placeholder="Scale" /><br>
  <input id="newDept" type="text" placeholder="Department" /><br>
  <button onclick="addNewItem()">Add Item</button>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbw8d4Ja93pNGr-avHL9UOE-goVchWyNFLXlwj9AzfHuqDVYJQMD1wkTnNJBn4SDjMCy/exec'; // <-- Replace this

let currentBarcode = '';
let currentItem = null;

function showStatus(msg, error = false) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.style.color = error ? 'red' : 'green';
}

function resetUI() {
  currentBarcode = '';
  currentItem = null;
  document.getElementById('foundItem').style.display = 'none';
  document.getElementById('newItemForm').style.display = 'none';
  showStatus('Waiting for scan...');
}

function scanSuccess(decodedText) {
  if (decodedText === currentBarcode) return;
  currentBarcode = decodedText;
  showStatus(`Scanned: ${currentBarcode}`);
  checkItem();
  html5QrCode.stop(); // stop scanning while interacting
}

function checkItem() {
  fetch(`${scriptURL}?barcode=${encodeURIComponent(currentBarcode)}`)
    .then(res => res.json())
    .then(data => {
      if (data.found) {
        currentItem = data.item;
        document.getElementById('itemName').textContent = currentItem.name;
        document.getElementById('itemScale').textContent = currentItem.scale;
        document.getElementById('itemDept').textContent = currentItem.department;
        document.getElementById('quantity').value = 1;
        document.getElementById('foundItem').style.display = 'block';
        document.getElementById('newItemForm').style.display = 'none';
      } else {
        document.getElementById('foundItem').style.display = 'none';
        document.getElementById('newItemForm').style.display = 'block';
      }
    })
    .catch(err => {
      showStatus('Error: ' + err, true);
    });
}

function changeQty(change) {
  const qty = document.getElementById('quantity');
  let value = parseInt(qty.value) + change;
  if (value >= 1 && value <= 10) qty.value = value;
}

function placeOrder() {
  const quantity = parseInt(document.getElementById('quantity').value);
  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'placeOrder',
      barcode: currentBarcode,
      name: currentItem.name,
      scale: currentItem.scale,
      department: currentItem.department,
      quantity: quantity
    }),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(res => res.json())
  .then(data => {
    showStatus(data.message);
    resetUI();
    startScanner();
  });
}

function addNewItem() {
  const name = document.getElementById('newName').value.trim();
  const scale = document.getElementById('newScale').value.trim();
  const department = document.getElementById('newDept').value.trim();
  if (!name || !scale || !department) {
    showStatus('Fill all fields.', true); return;
  }
  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'addItem',
      barcode: currentBarcode,
      name, scale, department
    }),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(res => res.json())
  .then(data => {
    showStatus(data.message);
    resetUI();
    startScanner();
  });
}

function deleteItem() {
  const password = document.getElementById('deletePassword').value;
  if (password !== '6986') {
    showStatus('Wrong password.', true); return;
  }
  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'deleteItem',
      barcode: currentBarcode,
      password: password
    }),
    headers: { 'Content-Type': 'application/json' }
  })
  .then(res => res.json())
  .then(data => {
    showStatus(data.message);
    resetUI();
    startScanner();
  });
}

// Camera setup (back cam preferred)
const html5QrCode = new Html5Qrcode("reader");

function startScanner() {
  Html5Qrcode.getCameras().then(devices => {
    const backCam = devices.find(cam =>
      cam.label.toLowerCase().includes('back') ||
      cam.label.toLowerCase().includes('rear') ||
      cam.label.toLowerCase().includes('environment')
    );
    const camId = backCam ? backCam.id : devices[0].id;
    html5QrCode.start(
      camId,
      { fps: 10, qrbox: { width: 250, height: 250 } },
      scanSuccess
    );
  }).catch(err => {
    showStatus('Camera error: ' + err, true);
  });
}

window.onload = () => {
  resetUI();
  startScanner();
};
</script>

</body>
</html>
