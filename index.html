<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Barcode Ordering App</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }
    h1 { text-align: center; }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      font-size: 16px;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: auto;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      background: white;
    }
    .section {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #message {
      margin-top: 15px;
      color: green;
      font-weight: bold;
    }
    .error { color: red; }
  </style>
</head>
<body>

<h1>ðŸ“¦ Barcode Order App</h1>

<div id="reader"></div>

<div id="message">Scan a barcode...</div>

<div class="section" id="itemSection" style="display:none;">
  <label>Item Name</label>
  <input id="itemName" readonly />

  <label>Scale</label>
  <input id="itemScale" readonly />

  <label>Department</label>
  <input id="itemDept" readonly />

  <label>Quantity</label>
  <select id="quantity">
    ${[...Array(10).keys()].map(i => `<option value="${i+1}">${i+1}</option>`).join('')}
  </select>

  <button onclick="placeOrder()">Place Order</button>
</div>

<div class="section" id="addSection" style="display:none;">
  <h3>Add New Item</h3>
  <label>Name</label>
  <input id="newName" />

  <label>Scale</label>
  <input id="newScale" />

  <label>Department</label>
  <input id="newDept" />

  <button onclick="addItem()">Add Item</button>
</div>

<div class="section" id="deleteSection">
  <h3>Delete Item</h3>
  <label>Barcode</label>
  <input id="deleteBarcode" />

  <label>Password</label>
  <input id="deletePass" type="password" />

  <button onclick="deleteItem()">Delete Item</button>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbwM8I_1LJrZtbYv7yII8dVkvh0PdtKzsklFcpMsiNdLD1OvIVMcC0Q10ePTg4X2Qu-X/exec';

let currentBarcode = '';
let currentItem = null;

function showMessage(msg, error=false) {
  const el = document.getElementById('message');
  el.textContent = msg;
  el.className = error ? 'error' : '';
}

function resetUI() {
  document.getElementById('itemSection').style.display = 'none';
  document.getElementById('addSection').style.display = 'none';
}

function handleScanSuccess(barcode) {
  if (barcode === currentBarcode) return;
  currentBarcode = barcode;
  resetUI();
  showMessage("Checking item...");

  fetch(scriptURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'search', barcode })
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === 'found') {
      currentItem = data.item;
      document.getElementById('itemName').value = currentItem.itemName;
      document.getElementById('itemScale').value = currentItem.scale;
      document.getElementById('itemDept').value = currentItem.department;
      document.getElementById('itemSection').style.display = 'block';
      showMessage("Item found. Ready to place order.");
    } else {
      document.getElementById('addSection').style.display = 'block';
      showMessage("Item not found. Please add.");
    }
  })
  .catch(err => {
    showMessage("Error: " + err.message, true);
  });
}

function placeOrder() {
  const qty = parseInt(document.getElementById('quantity').value);
  fetch(scriptURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'place_order',
      barcode: currentBarcode,
      quantity: qty
    })
  })
  .then(res => res.json())
  .then(data => {
    showMessage(data.message || 'Order placed');
    resetUI();
  });
}

function addItem() {
  const name = document.getElementById('newName').value.trim();
  const scale = document.getElementById('newScale').value.trim();
  const dept = document.getElementById('newDept').value.trim();
  if (!name || !scale || !dept) {
    showMessage("Please fill all fields", true);
    return;
  }
  fetch(scriptURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'add_item',
      barcode: currentBarcode,
      itemName: name,
      scale: scale,
      department: dept
    })
  })
  .then(res => res.json())
  .then(data => {
    showMessage(data.message || 'Item added');
    resetUI();
  });
}

function deleteItem() {
  const barcode = document.getElementById('deleteBarcode').value.trim();
  const password = document.getElementById('deletePass').value.trim();
  if (!barcode || !password) {
    showMessage("Enter both barcode and password", true);
    return;
  }

  fetch(scriptURL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'delete_item',
      barcode,
      password
    })
  })
  .then(res => res.json())
  .then(data => {
    showMessage(data.message);
    document.getElementById('deleteBarcode').value = '';
    document.getElementById('deletePass').value = '';
  });
}

// Start the scanner
const html5QrCode = new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(devices => {
  const backCamera = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];
  html5QrCode.start(
    backCamera.id,
    { fps: 10, qrbox: 250 },
    handleScanSuccess
  );
});
</script>
</body>
</html>
